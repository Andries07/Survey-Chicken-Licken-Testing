<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
<title>Chicken Licken Feedback</title>

<link rel="manifest" href="./manifest.json">
<link rel="icon" href="./icon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="./icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="./icon-512.png">

<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --card-rgba: rgba(0,0,0,0.65);
    --panel-rgba: rgba(255,255,255,0.78);
    --field-rgba: rgba(255,255,255,0.9);
    --text:#111;
    --green:#16a34a; --green2:#22c55e; --yellow:#facc15; --orange:#fb923c; --red:#dc2626;
  }
  html,body{margin:0;height:100%;font-family:Arial,system-ui,-apple-system,sans-serif;background:#000}

  /* Splash / Home */
  .home{
    position:fixed;inset:0;z-index:30;display:grid;place-items:center;
    background-image:url('./background.jpg');background-repeat:repeat;background-size:128px auto;
    padding:20px;
    touch-action: manipulation;
    -webkit-user-select:none;user-select:none;
  }
  .home .card{
    position:relative;z-index:2;
    background:var(--card-rgba);color:#fff;padding:24px;border-radius:16px;text-align:center;
    width:min(680px,94vw);
    box-shadow:0 18px 54px rgba(0,0,0,.55);
    cursor:pointer;
  }
  .home h1{
    margin:0 0 12px;
    font-size:clamp(34px, 9.5vh, 64px);
    line-height:1.04;letter-spacing:.3px;
  }
  .home p{margin:0 0 16px;opacity:.95;font-size:clamp(15px, 2.3vh, 20px)}
  .home .cta{
    display:inline-block;
    background:#ff6900;color:#fff;border:0;border-radius:14px;
    padding:18px 22px;font-weight:900;font-size:clamp(18px, 3.2vh, 24px);
    cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.35);
    -webkit-tap-highlight-color:transparent;
    touch-action: manipulation;
  }
  .home .tiny{font-size:clamp(10px, 1.8vh, 13px);opacity:.85;margin-top:12px}

  /* Main survey */
  .hero{
    height:100dvh;
    background-image:url('./background.jpg');
    background-repeat:repeat;background-size:128px auto;background-position:top left;
    display:grid;place-items:start center;padding:8px 2vw 10px;
  }
  .wrap{
    width:min(760px,96vw);height:100%;
    display:grid;grid-template-rows:auto 1fr auto;gap:6px;
  }
  h1{
    margin:0;text-align:center;color:#fff;font-weight:900;font-size:20px;line-height:1.1;
    text-shadow:0 2px 8px rgba(0,0,0,.55);
  }

  .content{min-height:0;overflow:hidden;display:grid;grid-template-rows:auto auto;gap:6px}
  .grid{display:grid;gap:6px}
  .card{background:var(--panel-rgba);border-radius:10px;padding:8px;box-shadow:0 6px 14px rgba(0,0,0,.22);backdrop-filter:saturate(120%) blur(2px)}
  .q-title{font-weight:900;font-size:15px;line-height:1.2;margin-bottom:4px;color:var(--text);letter-spacing:.2px}

  .q-row{display:grid;grid-template-columns:repeat(5,1fr);gap:5px}
  .opt{display:grid;place-items:center;gap:2px;padding:7px;min-height:42px;border-radius:9px;color:#fff;font-weight:800;cursor:pointer;border:2px solid transparent;user-select:none}
  .opt.active{outline:3px solid #000}
  .opt[data-score="5"]{background:var(--green)}
  .opt[data-score="4"]{background:var(--green2)}
  .opt[data-score="3"]{background:var(--yellow);color:#111}
  .opt[data-score="2"]{background:var(--orange)}
  .opt[data-score="1"]{background:var(--red)}
  .emo{font-size:17px}
  .lbl{font-size:11px}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  @media (max-width:640px){.grid2{grid-template-columns:1fr}}
  input,textarea{width:100%;padding:7px;border:1.2px solid #ddd;border-radius:9px;font-size:13px;min-width:0;background:var(--field-rgba)}
  textarea{min-height:54px;resize:vertical}
  .tiny{font-size:11px;color:#444;margin-top:2px}
  .error{outline:2px solid #dc2626}

  .row-end{display:flex;justify-content:space-between;align-items:center;gap:6px}
  .btn{background:#000;color:#fff;border:0;border-radius:10px;padding:9px 12px;font-weight:900;font-size:14px;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.25)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:#ffffff;opacity:.9;font-size:12px;min-height:16px;text-shadow:0 1px 3px rgba(0,0,0,.6)}

  .thanks{display:none;position:fixed;inset:0;z-index:20;place-items:center}
  .thanks::before{content:"";position:absolute;inset:0;background-image:url('./background.jpg');background-repeat:repeat;background-size:128px auto;opacity:.85}
  .thanks .in{position:relative;background:#fff;padding:14px;border-radius:12px;text-align:center;width:min(320px,92vw);box-shadow:0 18px 54px rgba(0,0,0,.4)}
</style>

<!-- minimal hotfix (no visual change to your design) -->
<style>
  html, body { height:100%; min-height:100%; }
  .home{ min-height:100svh !important; }
  .hero{ min-height:100svh !important; height:auto !important; }
</style>
</head>
<body>
<script>
  if('serviceWorker' in navigator){navigator.serviceWorker.getRegistrations().then(r=>r.forEach(x=>x.unregister()));}
  if('caches' in window){caches.keys().then(k=>k.forEach(c=>caches.delete(c)));}
</script>

<!-- HOME / SPLASH -->
<div class="home" id="home" aria-label="Start feedback">
  <div class="card" id="homeCard" role="button" aria-pressed="false">
    <h1>Please rate our service ‚≠ê</h1>
    <p>Tap below to give quick feedback and help us improve.</p>
    <button class="cta" id="startBtn" type="button" onclick="startSurvey()" role="button">Rate our service</button>
    <div class="tiny">Chicken Licken ‚Äî Quick Feedback</div>
  </div>
</div>

<!-- SURVEY -->
<div class="hero" id="survey" style="display:none">
  <div class="wrap">
    <h1>Chicken Licken Quick Feedback</h1>

    <div class="content">
      <div id="qList" class="grid"></div>

      <div class="card">
        <h3 class="q-title" style="margin:0 0 4px">Optional details</h3>
        <div class="tiny">If you add details, <b>Name</b>, <b>Surname</b> and a valid <b>10-digit Phone</b> are required and you must accept POPIA.</div>
        <div class="grid2" style="margin-top:6px">
          <div><input id="name" placeholder="Name" autocomplete="off" maxlength="50"></div>
          <div><input id="surname" placeholder="Surname" autocomplete="off" maxlength="50"></div>
        </div>
        <div class="grid2" style="margin-top:6px">
          <div><input id="phone" placeholder="Phone (10 digits)" maxlength="10" autocomplete="off" inputmode="numeric" pattern="[0-9]*"></div>
          <div><input id="email" placeholder="Email (optional)" autocomplete="off" inputmode="email"></div>
        </div>
        <div style="margin-top:6px">
          <textarea id="feedback" placeholder="Additional feedback (optional)" autocomplete="off" maxlength="3000"></textarea>
        </div>
        <label style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:start;margin-top:6px">
          <input type="checkbox" id="popia" style="margin-top:3px">
          <small>I consent to processing my personal info for service quality in line with POPIA.</small>
        </label>
        <label style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:start;margin-top:4px">
          <input type="checkbox" id="mk" style="margin-top:3px">
          <small>I agree to receive promotions and can unsubscribe anytime.</small>
        </label>
      </div>
    </div>

    <div class="row-end">
      <div class="muted" id="storeTag"></div>
      <div class="muted" id="statusTxt"></div>
      <button class="btn" id="submitBtn" disabled>Submit</button>
    </div>
  </div>
</div>

<div class="thanks" id="thanks">
  <div class="in">
    <h2 style="margin:0 0 6px">Thank you!</h2>
    <p style="margin:0 0 6px">Your feedback was recorded.</p>
    <div class="tiny">Ready for the next customer‚Ä¶</div>
  </div>
</div>

<script>
/* ===== UTIL ===== */
function normSpaces(s){return (s||'').replace(/\+/g,' ').trim();}
function getParamAny(keys){const u=new URL(location.href);for(const k of keys){const v=u.searchParams.get(k);if(v)return normSpaces(v);}if(u.hash&&u.hash.includes('=')){const h=new URLSearchParams(u.hash.replace(/^#/,''));for(const k of keys){const v=h.get(k);if(v)return normSpaces(v);}}return '';}
function getParam(k){const u=new URL(location.href);return normSpaces(u.searchParams.get(k));}


function getStoreId(){
  const keys=['store','Store','storeId','StoreId'];
  let v=getParamAny(keys);
  if(v){
    try{ localStorage.setItem('cl_storeId',v); }catch(_){}
    return v;
  }
  try{
    const cached = localStorage.getItem('cl_storeId')||'';
    if(cached) return cached;
  }catch(_){}
  return 'CL-Witbank-Highveld';
}
function getDeviceLabel(){
  let v=getParam('device');
  if(v){
    try{ localStorage.setItem('cl_deviceLabel',v); }catch(_){}
    return v;
  }
  try{
    const cached = localStorage.getItem('cl_deviceLabel')||'';
    if(cached) return cached;
  }catch(_){}
  return 'Front Counter';
}

/* ===== CONFIG ===== */
const CFG = {
  apiUrl: "https://script.google.com/macros/s/AKfycbzKKnv_zRA20JHbnBnoo2S9PO9Rho-OqKIFaRCihD7eXkbrgcxZJQxrm95aQ5bHjBZdZg/exec",
  token:  "CHANGE_ME_SUPER_SECRET",
  storeId:     getStoreId(),
  deviceLabel: getDeviceLabel(),
  deviceId:    getDeviceId()
};

/* ===== QUESTIONS ===== */
const QUESTIONS=[
  {id:'Q1',text:'Speed of service'},
  {id:'Q2',text:'Friendliness of staff'},
  {id:'Q3',text:'Order accuracy'},
  {id:'Q4',text:'Cleanliness of store'},
  {id:'Q5',text:'Overall experience'}
];
const CHOICES=[
  {txt:'Excellent',score:5,emo:'üòÑ'},
  {txt:'Good',     score:4,emo:'üôÇ'},
  {txt:'Average',  score:3,emo:'üòê'},
  {txt:'Poor',     score:2,emo:'üôÅ'},
  {txt:'Bad',      score:1,emo:'üò°'}
];

/* ===== RENDER ===== */
function makeQuestion(q){
  const card=document.createElement('div');card.className='card';
  const title=document.createElement('div');title.className='q-title';title.textContent=q.text;
  const row=document.createElement('div');row.className='q-row';row.dataset.qid=q.id;
  CHOICES.forEach(c=>{
    const d=document.createElement('div');
    d.className='opt';d.dataset.score=c.score;
    d.innerHTML=`<div class="emo">${c.emo}</div><div class="lbl">${c.txt}</div>`;
    d.addEventListener('click',()=>{
      row.querySelectorAll('.opt').forEach(x=>x.classList.remove('active'));
      d.classList.add('active');
      updateSubmitState();
    });
    row.appendChild(d);
  });
  card.appendChild(title);card.appendChild(row);
  return card;
}
function render(){
  const list=document.getElementById('qList');list.innerHTML='';
  QUESTIONS.forEach(q=>list.appendChild(makeQuestion(q)));
  document.getElementById('storeTag').textContent=`${CFG.storeId} ‚Ä¢ ${CFG.deviceLabel} ‚Ä¢ ${CFG.deviceId||'no deviceId'}`;
}

/* ===== VALIDATION ===== */
function val(id){return(document.getElementById(id).value||'').trim();}
function detailsAnyFilled(){
  const name=val('name'), sur=val('surname'), ph=val('phone'), em=(val('email')||'').toLowerCase(), fb=val('feedback');
  const hasName = name.length>=2, hasSur=sur.length>=2;
  const hasPhone = /^\d{10}$/.test(ph);
  const hasEmail = !!em && /.+@.+\..+/.test(em);
  const hasFb = fb.length>=3;
  return hasName || hasSur || hasPhone || hasEmail || hasFb;
}
function allAnswered(){return QUESTIONS.every(q=>document.querySelector(`.q-row[data-qid="${q.id}"] .opt.active`));}
function markError(id,on){const el=document.getElementById(id);if(el)el.classList.toggle('error',!!on);}
function updateSubmitState(){
  let ok=allAnswered();
  const any=detailsAnyFilled();
  const requireName=any&&!val('name');
  const requireSurname=any&&!val('surname');
  const phoneVal=val('phone');
  const requirePhone=any&&!/^\d{10}$/.test(phoneVal);
  const requirePOPIA=any&&!document.getElementById('popia').checked;
  const em=val('email');
  const badEmail=em&&!/.+@.+\..+/.test(em);
  markError('name',requireName);markError('surname',requireSurname);markError('phone',requirePhone);
  if(requireName||requireSurname||requirePhone||requirePOPIA||badEmail)ok=false;
  const btn=document.getElementById('submitBtn'); if(btn) btn.disabled=!ok;
  return ok;
}
document.addEventListener('input',updateSubmitState);

/* ===== FLOW ===== */
const homeEl = document.getElementById('home');
const homeCard = document.getElementById('homeCard');
const startBtn = document.getElementById('startBtn');
const surveyEl = document.getElementById('survey');

function startSurvey(){
  try{
    homeEl.style.display='none';
    surveyEl.style.display='grid';
    render();
  }catch(e){ console.error('startSurvey error', e); }
}
document.addEventListener('DOMContentLoaded', ()=>{
  if (startBtn && !startBtn._bound) {
    startBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); startSurvey(); }, { passive:false });
    startBtn._bound = true;
  }
  if (homeCard && !homeCard._bound) {
    homeCard.addEventListener('click', (e)=>{
      const tiny = e.target.closest('.tiny'); if(tiny) return;
      startSurvey();
    }, { passive:true });
    homeCard._bound = true;
  }
  homeCard.addEventListener('keydown', (e)=>{
    if (e.code === 'Enter' || e.code === 'Space'){ e.preventDefault(); startSurvey(); }
  });
});

/* ===== SUBMIT ===== */
let inFlight = false;
function within24h(ts){return (Date.now() - Number(ts)) < 24*60*60*1000;}
function dupLocalBlockIfAny(){
  const phone=val('phone'); const email=(val('email')||'').toLowerCase();
  if(!phone && !email) return false;
  const kP = phone ? `cl_last_phone_${phone}` : null;
  const kE = email ? `cl_last_email_${email}` : null;
  if(kP && localStorage.getItem(kP) && within24h(localStorage.getItem(kP))) return true;
  if(kE && localStorage.getItem(kE) && within24h(localStorage.getItem(kE))) return true;
  return false;
}
function dupLocalMark(){
  const phone=val('phone'); const email=(val('email')||'').toLowerCase();
  if(phone) localStorage.setItem(`cl_last_phone_${phone}`, String(Date.now()));
  if(email) localStorage.setItem(`cl_last_email_${email}`, String(Date.now()));
}

function fireAndForgetSend(bodyStr){
  try{
    const ok = navigator.sendBeacon(CFG.apiUrl, new Blob([bodyStr], {type:'text/plain;charset=utf-8'}));
    if(ok) return;
  }catch(_){}
  try{
    fetch(CFG.apiUrl,{ method:'POST', mode:'no-cors',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body:bodyStr, keepalive:true });
  }catch(_){}
}

document.addEventListener('DOMContentLoaded', ()=>{
  const submit = document.getElementById('submitBtn');
  if(!submit) return;
  submit.addEventListener('click',()=>{
    if(inFlight) return;

    if (typeof window.CL_QR_canSubmit === 'function' && !window.CL_QR_canSubmit()){
      toast('You have already submitted a review in the last 24 hours.');
      return;
    }

    if(!allAnswered()){toast('Please answer all questions');return;}
    const any=detailsAnyFilled();
    if(any){
      if(!val('name')){toast('Please enter your Name');return;}
      if(!val('surname')){toast('Please enter your Surname');return;}
      const ph=val('phone');if(!/^\d{10}$/.test(ph)){toast('Enter a valid 10-digit Phone');return;}
      if(!document.getElementById('popia').checked){toast('Tick POPIA consent');return;}
    }
    const em=val('email');if(em&&!/.+@.+\..+/.test(em)){toast('Enter a valid Email');return;}
    if(dupLocalBlockIfAny()){ toast('You have already submitted in the last 24 hours.'); return; }

    const answers=QUESTIONS.map(q=>{
      const el=document.querySelector(`.q-row[data-qid="${q.id}"] .opt.active`);
      const score=Number(el.dataset.score);
      const ch=CHOICES.find(c=>c.score===score);
      return{questionId:q.text,choiceText:ch.txt,choiceScore:score};
    });

    const payload={
      token:CFG.token,
      clientId:`${Date.now()}-${Math.random().toString(16).slice(2)}`,
      storeId:CFG.storeId,deviceLabel:CFG.deviceLabel,deviceId:CFG.deviceId,
      pressedAtUtc:new Date().toISOString(),answers,
      marketingConsent:document.getElementById('mk').checked===true,
      sourceMode: (window.CL_QR_ctx && window.CL_QR_ctx.mode) || 'tablet',
      qrUid: (window.CL_QR_ctx && window.CL_QR_ctx.uid) || '',
      customer:{
        name:val('name'),surname:val('surname'),phone:val('phone'),
        email:val('email'),feedback:val('feedback'),
        consent:document.getElementById('popia').checked||null
      }
    };

    inFlight = true;
    submit.disabled = true;
    fireAndForgetSend(JSON.stringify(payload));
    dupLocalMark();
    if (typeof window.CL_QR_markSubmitted === 'function') window.CL_QR_markSubmitted();
    showThanks();
  });
});

function showThanks(){
  const el=document.getElementById('thanks');
  el.style.display='grid';
  clearTimeout(el._t);
  el._t=setTimeout(()=>{
    el.style.display='none';
    resetForm();
    surveyEl.style.display='none';
    homeEl.style.display='grid';
  }, 3000);
}
function resetForm(){
  document.querySelectorAll('.opt').forEach(x=>x.classList.remove('active'));
  ['name','surname','phone','email','feedback'].forEach(id=>{const e=document.getElementById(id); if(e) e.value='';});
  document.getElementById('popia').checked=false;
  document.getElementById('mk').checked=false;
  inFlight = false;
  updateSubmitState();
}
function toast(msg){const s=document.getElementById('statusTxt');if(!s)return;s.textContent=msg;clearTimeout(s._t);s._t=setTimeout(()=>s.textContent='',1600);}
</script>

<!-- QR overlay -->
<script>
(function(){
  function qp(k){ try{ return (new URL(location.href).searchParams.get(k)||'').trim(); }catch(_){ return '' } }
  function gen(){ return 'qr_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }

  var STORE_BY_SLUG = {
    "witbank-highveld":"CL-Witbank-Highveld",
    "saveways":"CL-Saveways",
    "sasol":"CL-Sasol",
    "midellburg-mall":"CL-Midellburg-Mall",
    "mhluzi":"CL-Mhluzi",
    "groblersdal-mall":"CL-Groblersdal-Mall",
    "epping":"CL-Epping",
    "cape-station":"CL-Cape-Station",
    "athlone":"CL-Athlone",
    "bronkhorstspruit":"CL-Bronkhorstspruit",
    "ok":"CL-Ok"
  };

  var slug  = (qp('s')||'').toLowerCase();
  var src   = (qp('source')||'').toLowerCase();

  if (slug && STORE_BY_SLUG[slug]) {
    CFG.storeId = STORE_BY_SLUG[slug];
    try{ localStorage.setItem('cl_storeId', CFG.storeId); }catch(_){}
  }

  window.CL_QR_ctx = { mode:'tablet', uid:'' };

  if (src === 'qr-in' || src === 'qr-drive') {
    var mode = (src === 'qr-in') ? 'qr-in' : 'qr-drive';
    window.CL_QR_ctx.mode = mode;

    CFG.deviceLabel = (mode === 'qr-in') ? 'QR Poster (Inside)' : 'QR Poster (Drive-Thru)';
    CFG.deviceId    = ((mode === 'qr-in') ? 'QRIN-' : 'QRDRIVE-') + (slug || (qp('store')||'unknown'));

    try{
      var uidKey = 'cl_qr_uid_' + mode;
      var uid = localStorage.getItem(uidKey);
      if(!uid){ uid = gen(); localStorage.setItem(uidKey, uid); }
      window.CL_QR_ctx.uid = uid;

      window.CL_QR_canSubmit = function(){
        var key = 'cl_qr_last_' + mode + '_' + uid;
        var last = parseInt(localStorage.getItem(key)||'0',10);
        if (last && (Date.now()-last) < 24*60*60*1000) return false;
        return true;
      };
      window.CL_QR_markSubmitted = function(){
        var key = 'cl_qr_last_' + mode + '_' + uid;
        localStorage.setItem(key, String(Date.now()));
      };
    }catch(_){}
  }else{
    window.CL_QR_canSubmit = function(){ return true; };
    window.CL_QR_markSubmitted = function(){};
  }
})();
</script>

<!-- render safeguard -->
<script>
(function(){
  function ensureQuestions(){
    if (!Array.isArray(window.QUESTIONS) || !window.QUESTIONS.length){
      window.QUESTIONS = [
        {id:'Q1',text:'Speed of service'},
        {id:'Q2',text:'Friendliness of staff'},
        {id:'Q3',text:'Order accuracy'},
        {id:'Q4',text:'Cleanliness of store'},
        {id:'Q5',text:'Overall experience'}
      ];
    }
    if (!Array.isArray(window.CHOICES) || !window.CHOICES.length){
      window.CHOICES = [
        {txt:'Excellent',score:5,emo:'üòÑ'},
        {txt:'Good',     score:4,emo:'üôÇ'},
        {txt:'Average',  score:3,emo:'üòê'},
        {txt:'Poor',     score:2,emo:'üôÅ'},
        {txt:'Bad',      score:1,emo:'üò°'}
      ];
    }
  }
  function fallbackBuild(){
    var list = document.getElementById('qList'); if (!list) return;
    list.innerHTML = '';
    window.QUESTIONS.forEach(function(q){
      var card = document.createElement('div'); card.className='card';
      var title=document.createElement('div'); title.className='q-title'; title.textContent=q.text;
      var row=document.createElement('div'); row.className='q-row'; row.dataset.qid=q.id;
      window.CHOICES.forEach(function(c){
        var d=document.createElement('div'); d.className='opt'; d.dataset.score=c.score;
        d.innerHTML = '<div class="emo">'+c.emo+'</div><div class="lbl">'+c.txt+'</div>';
        d.addEventListener('click', function(){
          row.querySelectorAll('.opt').forEach(function(x){x.classList.remove('active');});
          d.classList.add('active');
          if (typeof window.updateSubmitState === 'function') window.updateSubmitState();
        });
        row.appendChild(d);
      });
      card.appendChild(title); card.appendChild(row);
      list.appendChild(card);
    });
    if (typeof window.updateSubmitState === 'function') window.updateSubmitState();
  }
  function safeRenderNow(){
    try{
      ensureQuestions();
      var list = document.getElementById('qList');
      if (!list) return;
      if (!list.children || list.children.length === 0){
        if (typeof window.render === 'function'){ window.render(); }
        if (!list.children || list.children.length === 0){ fallbackBuild(); }
      }
    }catch(e){ console.error('Render safeguard error:', e); }
  }
  window.addEventListener('load', safeRenderNow);
  if (typeof window.startSurvey === 'function' && !window.startSurvey._patched){
    var _orig = window.startSurvey;
    window.startSurvey = function(){ _orig.apply(this, arguments); safeRenderNow(); };
    window.startSurvey._patched = true;
  }
})();
</script>

<!-- global startSurvey kept for inline onclick -->
<script>
window.startSurvey = window.startSurvey || function(){
  try{
    const home = document.getElementById('home') || document.querySelector('.home,.page');
    const survey = document.getElementById('survey');
    if (home && home!==survey) home.style.display='none';
    if (survey) survey.style.display='grid';
    window.scrollTo(0,0);
    const first = document.querySelector('#survey button, #survey input, #survey textarea, #survey select');
    if (first) first.focus();
  }catch(_){}
};
</script>

<!-- === HEARTBEAT (non-blocking; no CORS preflight) === -->
<script>
(function(){
  const HEARTBEAT_MS = 120000; // every 2 minutes

  function endpoint(){ return (CFG && CFG.apiUrl) || null; }
  function val(x, d){ return (typeof x !== 'undefined' && x !== null) ? x : d; }

  function hbSend(bodyStr){
    try{
      if (navigator.sendBeacon){
        const ok = navigator.sendBeacon(endpoint(), new Blob([bodyStr], {type:'text/plain;charset=utf-8'}));
        if (ok) return;
      }
    }catch(_){}
    try{
      fetch(endpoint(), {
        method:'POST',
        mode:'no-cors',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body: bodyStr,
        keepalive:true
      });
    }catch(_){}
  }

  function ping(reason){
    const url = endpoint(); if(!url) return;
    const payload = {
      type: 'heartbeat',
      token: val(CFG && CFG.token, ''),
      clientId: val((CFG && CFG.deviceId), '') + '-' + Date.now(),
      storeId:  val(CFG && CFG.storeId, ''),
      deviceId: val(CFG && CFG.deviceId, ''),
      deviceLabel: val(CFG && CFG.deviceLabel, ''),
      pageVisible: document.visibilityState === 'visible',
      sentAtUtc: new Date().toISOString(),
      reason: reason || 'interval',
      userAgent: navigator.userAgent || ''
    };
    hbSend(JSON.stringify(payload));
  }

  function schedule(){
    clearInterval(window.__hbInt);
    setTimeout(()=>ping('initial'), 15000);
    window.__hbInt = setInterval(()=>ping('interval'), HEARTBEAT_MS);
  }

  window.addEventListener('load',   ()=>{ schedule(); ping('load'); });
  window.addEventListener('focus',  schedule);
  document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='visible') schedule(); });
})();
</script>

</body>
</html>
