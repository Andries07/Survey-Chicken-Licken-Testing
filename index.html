<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
<title>Chicken Licken Feedback</title>

<link rel="manifest" href="./manifest.json">
<link rel="icon" href="./icon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="./icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="./icon-512.png">

<style>
  *,*::before,*::after{box-sizing:border-box}
html, body{height:100%;background-image:url('./background.jpg');background-repeat:repeat;background-size:128px auto;background-position:top left;}
  :root{
    --card-rgba: rgba(0,0,0,0.65);
    --field-rgba: rgba(255,255,255,0.9);
    --accent:#ff6900;
    --green:#2da44e;
    --green2:#63c174;
    --yellow:#f7d070;
    --orange:#ff8a3d;
    --red:#ef4444;
  }
  html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#111;color:#fff}
  .page{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
  .hero{
    min-height:100dvh;display:grid;place-items:center;padding:8px 2vw;
    background-image:url('./background.jpg');
    background-repeat:repeat;background-size:128px auto;background-position:top left;
  }
  .wrap{
    width:min(760px,96vw);height:100%;
    display:grid;grid-template-rows:auto 1fr auto;gap:6px;
  }
  h1{
    margin:0;text-align:center;color:#fff;font-weight:900;font-size:20px;line-height:1.1;
    text-shadow:0 2px 8px rgba(0,0,0,.55);
  }

  .content{min-height:0;overflow:hidden;display:grid;grid-template-rows:auto auto;gap:6px}
  .grid{display:grid;gap:6px}

  .card{
    background:var(--card-rgba);
    border-radius:16px;
    padding:14px 14px;
    box-shadow: 0 10px 22px rgba(0,0,0,.24), 0 2px 8px rgba(0,0,0,.3);
    backdrop-filter: blur(6px);
  }

  .cta{
    appearance:none;border:0;border-radius:999px;background:var(--accent);
    color:#fff;font-weight:800;font-size:16px;line-height:1;padding:14px 20px;cursor:pointer;
    box-shadow:0 6px 16px rgba(0,0,0,.35), inset 0 -2px 0 rgba(0,0,0,.25);
    display:block;margin:8px auto 2px auto
  }
  .cta:active{transform:translateY(1px)}

  .q{font-weight:800;margin:0}
  .opts{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
  .opt{
    display:grid;gap:2px;place-items:center;
    padding:10px;border-radius:12px;cursor:pointer;user-select:none;border:0
  }
  .opt:active{transform:translateY(1px)}
  .opt[data-score="5"]{background:var(--green)}
  .opt[data-score="4"]{background:var(--green2)}
  .opt[data-score="3"]{background:var(--yellow);color:#111}
  .opt[data-score="2"]{background:var(--orange)}
  .opt[data-score="1"]{background:var(--red)}
  .emo{font-size:17px}
  .lbl{font-size:11px}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  @media (max-width:640px){.grid2{grid-template-columns:1fr}}
  input,textarea{width:100%;padding:7px;border:1.2px solid #ddd;border-radius:9px;font-size:13px;min-width:0;background:var(--field-rgba)}
  textarea{min-height:54px;resize:vertical}
  .tiny{font-size:11px;color:#444;margin-top:2px}
  .error{outline:2px solid #dc2626}

  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{background:#fff;color:#111;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer;border:0}
  .chip[data-on="1"]{background:#111;color:#fff;outline: 2px solid #fff}

  footer{font-size:11px;color:#bbb;text-align:center;padding:8px 0}
</style>
</head>
<body>

<div class="page" id="home">
  <div class="hero" id="hero">
    <div class="wrap">
      <div class="card" id="homeCard" role="button" aria-pressed="false">
        <h1>Please rate our service ‚≠ê</h1>
        <p>Tap below to give quick feedback and help us improve.</p>
        <button class="cta" id="startBtn" type="button" onclick="startSurvey()" role="button">Rate our service</button>
        <div class="tiny">Chicken Licken ‚Äî Quick Feedback</div>
      </div>
    </div>
  </div>
  <footer>v1.0</footer>
</div>

<!-- SURVEY -->
<div class="hero" id="survey" style="display:none">
  <div class="wrap">
    <h1>Chicken Licken Quick Feedback</h1>

    <div class="content">
      <div class="grid">
        <div class="card">
          <p class="q">How was our service today?</p>

          <div class="grid" id="qs"></div>
        </div>

        <div class="card">
          <p class="q">Leave your details (optional)</p>
          <div class="grid2">
            <div><input id="name" placeholder="Name"></div>
            <div><input id="surname" placeholder="Surname"></div>
          </div>
          <div class="grid2">
            <div><input id="phone" placeholder="Phone (10 digits)"></div>
            <div><input id="email" placeholder="Email"></div>
          </div>
          <div><textarea id="feedback" placeholder="Anything we can improve? (optional)"></textarea></div>
          <label class="tiny"><input type="checkbox" id="popia"> I consent to be contacted about my feedback (POPIA)</label>
          <label class="tiny"><input type="checkbox" id="marketing"> I want to receive specials (optional)</label>
        </div>

        <div>
          <button id="submitBtn" class="cta" disabled>Submit feedback</button>
          <div class="tiny">By submitting you agree to our terms.</div>
        </div>
      </div>

      <div class="card" id="thanks" style="display:none">
        <h1>Thank you! üß°</h1>
        <p>Your feedback helps us improve.</p>
      </div>
    </div>

  </div>
</div>

<script>
  const STORE_BY_SLUG = {
    "witbank-highveld":"CL-Witbank-Highveld",
    "witbank-conradie":"CL-Witbank-Conradie",
    "saveways":"CL-Saveways",
    "sasol":"CL-Sasol",
    "midellburg-mall":"CL-Midellburg-Mall",
    "mhluzi":"CL-Mhluzi",
    "groblersdal-mall":"CL-Groblersdal-Mall",
    "epping":"CL-Epping",
    "cape-station":"CL-Cape-Station",
    "athlone":"CL-Athlone",
    "bronkhorstspruit":"CL-Bronkhorstspruit"
  };
  function normSpaces(v){return v==null?'':String(v).trim();}
  function getParam(k){const u=new URL(location.href);return normSpaces(u.searchParams.get(k));}
  const _slug = getParam('s');
  const _source = getParam('source'); // "qr" when scanned from poster
</script>

<script>
const CFG = {
  apiUrl: "https://script.google.com/macros/s/AKfycbxb8JHst8eLOM1OvaEBDoXMmWMjUUwtKlgwtCJc4faD4myBvqhzfAJ1T7NYTI2dGX0i/exec", // set this
  token:  "CHANGE_ME_SUPER_SECRET",               // must match Apps Script SHARED_TOKEN

  // storeId now supports short slug (s=) and classic store=
  storeId:     STORE_BY_SLUG[_slug] || getParam('store') || 'CL-Witbank-Highveld',

  // When source=qr (from poster), label and id are clearly marked
  deviceLabel: (_source === 'qr' ? 'QR Poster' : (getParam('device') || 'Front Counter')),
  deviceId:    (_source === 'qr' ? ('QR-' + (_slug || getParam('store') || 'unknown')) : getDeviceId())
};

/* ===== QUESTIONS ===== */
const QUESTIONS=[
  {id:'Speed of service',text:'Speed of service'},
  {id:'Friendliness of staff',text:'Friendliness of staff'},
  {id:'Order accuracy',text:'Order accuracy'},
  {id:'Cleanliness of store',text:'Cleanliness of store'},
  {id:'Overall experience',text:'Overall experience'}
];

// Emoji scale preserved
const CHOICES=[
  {text:'Excellent',score:5,emo:'üòç'},
  {text:'Good',score:4,emo:'üòä'},
  {text:'Okay',score:3,emo:'üòê'},
  {text:'Poor',score:2,emo:'üòü'},
  {text:'Terrible',score:1,emo:'üò°'}
];

function getDeviceId(){
  const keys=['deviceId','deviceid','did','DeviceId'];
  for(const k of keys){const v=getParam(k); if(v){ localStorage.setItem('cl_deviceId',v); return v; }}
  let v=localStorage.getItem('cl_deviceId');
  if(!v) v=('A9-' + Math.random().toString(16).slice(2,10)).toUpperCase();
  v=String(v||'').trim();
  if(v) localStorage.setItem('cl_deviceId',v);
  return v;
}

function sel(qId,choice){
  // track selection
  ans[qId]=choice;
  renderQs();
  updateSubmitState();
}

function el(tag,attrs,...kids){
  const n=document.createElement(tag);
  if(attrs) for(const k in attrs){
    if(k==='dataset'){ for(const dk in attrs.dataset) n.dataset[dk]=attrs.dataset[dk]; }
    else if(k==='on'){ for(const evt in attrs.on) n.addEventListener(evt,attrs.on[evt]); }
    else if(k==='html'){ n.innerHTML=attrs.html; }
    else n.setAttribute(k,attrs[k]);
  }
  for(const k of kids){ if(k!=null) n.append(k) }
  return n;
}

let ans={};
function renderQs(){
  const qs=document.getElementById('qs'); qs.innerHTML='';
  QUESTIONS.forEach(q=>{
    const row=el('div', {class:'grid'});
    row.append(el('p',{class:'q'}, q.text));
    const opts=el('div',{class:'opts'});
    CHOICES.forEach(c=>{
      const b=el('button',{class:'opt',dataset:{score:c.score},on:{click:()=>sel(q.id,c)}},
        el('div',{class:'emo'}, c.emo),
        el('div',{class:'lbl'}, c.text)
      );
      if(ans[q.id]===c) b.style.outline='3px solid #fff';
      opts.append(b);
    });
    row.append(opts);
    qs.append(row);
  });
}

function val(id){ return normSpaces(document.getElementById(id)?.value || '') }
function markError(id,on){ const el=document.getElementById(id); if(!el) return; if(on) el.classList.add('error'); else el.classList.remove('error') }

function detailsAnyFilled(){
  return !!(val('name') || val('surname') || val('phone') || val('email') || val('feedback'));
}

function updateSubmitState(){
  let ok=true;
  const any=detailsAnyFilled();
  const requireName=any&&!val('name');
  const requireSurname=any&&!val('surname');
  const phoneVal=val('phone');
  const requirePhone=any&&!/^\d{10}$/.test(phoneVal);
  const requirePOPIA=any&&!document.getElementById('popia').checked;
  const em=val('email');
  const badEmail=em&&!/.+@.+\..+/.test(em);
  markError('name',requireName);markError('surname',requireSurname);markError('phone',requirePhone);
  if(requireName||requireSurname||requirePhone||requirePOPIA||badEmail)ok=false;
  document.getElementById('submitBtn').disabled=!ok;
}
document.addEventListener('input',updateSubmitState);

/* ===== FLOW ===== */
function showThanks(){
  document.getElementById('thanks').style.display='block';
  setTimeout(()=>{ location.href=location.pathname; }, 3000);
}

async function doSubmit(){
  const answers=QUESTIONS.map(q=>({questionId:q.id,choiceText:ans[q.id]?.text||'',choiceScore:ans[q.id]?.score||''}));
  const payload={
    token:CFG.token,
    clientId: String(Date.now()) + '-' + Math.random().toString(16).slice(2,8),
    storeId: CFG.storeId,
    deviceLabel: CFG.deviceLabel,
    deviceId: CFG.deviceId,
    pressedAtUtc: new Date().toISOString(),
    answers,
    customer:{
      name:val('name'),
      surname:val('surname'),
      phone:val('phone'),
      email:val('email'),
      feedback:val('feedback'),
      consent: document.getElementById('popia').checked || false
    },
    marketingConsent: document.getElementById('marketing').checked || false
  };

  // Instant UI feedback
  document.getElementById('submitBtn').disabled=true;
  document.getElementById('thanks').style.display='block';

  // Try sendBeacon first (fire-and-forget)
  let sent=false;
  try{
    const blob=new Blob([JSON.stringify(payload)],{type:'application/json'});
    if(navigator.sendBeacon){
      sent = navigator.sendBeacon(CFG.apiUrl, blob);
    }
  }catch(_){}

  // Fallback to fetch
  if(!sent){
    try{
      await fetch(CFG.apiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    }catch(_){}
  }

  // Reset after 3s (gives server time)
  setTimeout(()=>{ location.href=location.pathname; }, 3000);
}

document.addEventListener('DOMContentLoaded',()=>{
  renderQs();
  updateSubmitState();
  document.getElementById('submitBtn').addEventListener('click',doSubmit);
});

// Global entry for the home button
function startSurvey(){
  var home=document.getElementById('home');
  var survey=document.getElementById('survey');
  if(home) home.style.display='none';
  if(survey) survey.style.display='block';
  window.scrollTo(0,0);
  var first=document.querySelector('#survey button, #survey input, #survey textarea, #survey select');
  if(first) first.focus();
}
</script>
</body>
</html>
